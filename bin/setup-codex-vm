#!/usr/bin/env bash
# Abort on errors, undefined variables, or errors in pipelines
set -euo pipefail

# Determine repository root (directory one level above this script)
REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Read required Ruby version from .ruby-version
RUBY_VERSION="$(tr -d '\n[:space:]' < "$REPO_ROOT/.ruby-version")"

if [[ -z "$RUBY_VERSION" ]]; then
  echo "Error: Could not determine Ruby version. Ensure .ruby-version exists at repo root." >&2
  exit 1
fi

echo "Installing asdf and Ruby $RUBY_VERSION on Ubuntu 24.04..."

# Install minimal prerequisites for asdf (curl & git)
if ! command -v git >/dev/null 2>&1 || ! command -v curl >/dev/null 2>&1; then
  echo "Installing prerequisites (git, curl)..."
  sudo apt-get update -y
  sudo DEBIAN_FRONTEND=noninteractive apt-get install -y git curl
fi

# Install asdf if it is not already present
export ASDF_DIR="$HOME/.asdf"
if [[ ! -d "$ASDF_DIR" ]]; then
  echo "Cloning asdf..."
  git clone https://github.com/asdf-vm/asdf.git "$ASDF_DIR" --branch v0.14.0
  # Persist shell integration for future sessions
  {
    echo '. "$HOME/.asdf/asdf.sh"'
    echo '. "$HOME/.asdf/completions/asdf.bash"'
  } >> "$HOME/.bashrc"
else
  echo "asdf already installed. Updating..."
  git -C "$ASDF_DIR" pull --quiet --ff-only
fi

# Source asdf for the current script execution
# shellcheck disable=SC1090
. "$ASDF_DIR/asdf.sh"

# Add Ruby plugin if missing
if ! asdf plugin-list | grep -qx ruby; then
  echo "Adding Ruby plugin to asdf..."
  asdf plugin add ruby https://github.com/asdf-vm/asdf-ruby.git
fi

# Prefer binary builds when available
export RUBY_BUILD_BINARY=1

# Install Ruby version if necessary
if ! asdf list ruby | grep -qx "$RUBY_VERSION"; then
  echo "Installing Ruby $RUBY_VERSION via asdf (binary preferred)..."
  asdf install ruby "$RUBY_VERSION"
fi

# Set global Ruby version
asdf global ruby "$RUBY_VERSION"

echo "Ruby $(ruby -v) installed."

# Ensure bundler is installed (comes with Ruby >2.6 but we pin just in case)
if ! gem list -i bundler >/dev/null 2>&1; then
  gem install --no-document bundler
fi

echo "Bundler $(bundler -v) installed."

echo "Setup complete! You may need to restart your shell for asdf changes to take effect."

